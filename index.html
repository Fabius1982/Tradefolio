<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tradefolio</title>
    
    <!-- Meta per l'aspetto su mobile -->
    <meta name="theme-color" content="#1f2937"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tradefolio">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/ffffff/000000?text=TF">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Stili generali del corpo */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #1f2937; /* Grigio Scuro */
            color: #F3F4F6; /* Testo Bianco Sporco */
        }
        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }
        /* Classi per profitto e perdita */
        .profit { color: #22c55e; font-weight: 600; }
        .loss { color: #ef4444; font-weight: 600; }

        /* Stili per lo splash screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1f2937;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1020;
            transition: opacity 0.8s ease-out;
        }

        #app-container {
            transition: opacity 0.8s ease-in;
            opacity: 0;
            pointer-events: none;
        }
        #app-container.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Stili per il nuovo calendario orizzontale */
        .horizontal-calendar-wrapper {
            overflow-x: auto;
            padding-bottom: 1rem; /* Spazio per la barra di scorrimento */
            -webkit-overflow-scrolling: touch; /* Scrolling fluido su iOS */
        }
        .horizontal-calendar-content {
            display: flex;
            gap: 0.75rem; /* Spazio tra le colonne dei giorni */
            min-width: min-content; /* Permette al contenuto di definire la larghezza */
            align-items: flex-start; 
        }
        .day-column {
            flex: 0 0 200px; /* Larghezza fissa per ogni colonna, non si ridimensiona/espande */
            display: flex;
            flex-direction: column;
            background-color: #374151;
            border-radius: 0.75rem;
            padding: 0.75rem;
            border: 1px solid #4b5563;
            min-height: 150px; /* Altezza minima per tutte le colonne, anche quelle vuote */
        }

        /* Stili per gli elementi di trade */
        .trade-item {
            border: 1px solid #4b5563;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            line-height: 1.3;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .trade-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .trade-actions { display: flex; gap: 0.25rem; }
        .action-btn { 
            padding: 0.2rem 0.4rem; 
            font-size: 0.7rem; 
            border-radius: 0.25rem; 
            color: white; 
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* Stili per i modali */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #374151; /* Grigio Chiaro */
            padding: 1rem;
            border-radius: 1rem;
            width: 95%;
            position: relative;
            color: #F3F4F6;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            border: 1px solid #4b5563;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .modal-body { overflow-y: auto; padding-right: 0.5rem; }
        .modal-input { 
            width: 100%; 
            border: 1px solid #4b5563; 
            border-radius: 0.5rem; 
            padding: 0.6rem;
            background-color: #4b5563; 
            color: #F3F4F6;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .modal-input:focus {
            outline: none;
            border-color: #FBBF24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
        }
        .modal-btn { 
            font-weight: 600; 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            transition: all 0.3s; 
            cursor: pointer; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .modal-btn:disabled { 
            background-color: #4b5563; 
            cursor: not-allowed; 
            opacity: 0.7; 
        }
        
        /* Stili per lo slider della leva */
        .custom-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4b5563;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }
        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #FBBF24;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #374151;
        }
        .custom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #FBBF24;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #374151;
        }

        /* Stili per il ticker dei prezzi */
        .ticker-wrap {
          width: 100%;
          overflow: hidden;
          background-color: #111827; /* Grigio piÃ¹ scuro per il ticker */
          padding: 0.25rem 0; /* Ridotto per compattezza */
          white-space: nowrap;
        }
        .ticker-move { display: inline-block; animation: ticker 180s linear infinite; }
        .ticker-item {
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0 1.5rem;
          color: #D1D5DB;
          font-size: 0.8rem; /* Ridotto per compattezza */
        }
        .ticker-item img { width: 16px; height: 16px; }
        @keyframes ticker {
          0% { transform: translateX(0); }
          100% { transform: translateX(-100%); }
        }
        
        /* Stile per il loader */
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #4b5563;
            border-bottom-color: #FBBF24;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Stili Calendario Economico */
        .star-filled { color: #FBBF24; }
        .star-empty { color: #6B7280; }

        /* Stile per linea nel logo */
        .trade-line {
            position: relative;
            display: inline-block;
        }
        .trade-line::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 2px;
            background-color: #1f2937; /* Colore dello sfondo principale */
            transform: translateY(-50%);
            transform-origin: center;
        }

        /* Stili per il menu laterale */
        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100%;
            background-color: rgba(31, 41, 55, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-right: 1px solid #4b5563;
            box-shadow: 5px 0px 25px rgba(0, 0, 0, 0.3);
            transform: translateX(-100%) scale(0.95);
            transform-origin: left center;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1010;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
        }
        .side-menu.open {
            transform: translateX(0) scale(1);
        }
        .menu-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 1005;
        }
        .menu-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        /* Stili per forzare il dropdown in stile desktop su mobile */
        .native-hidden-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Stili Convertitore */
        .converter-col {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #4b5563;
        }
        .converter-input {
            width: 100%;
            background: transparent;
            border: none;
            color: #F3F4F6;
            font-size: 1.875rem; /* text-3xl */
            font-weight: 600;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #4b5563;
            transition: border-color 0.2s;
        }
        .converter-input:focus {
            outline: none;
            border-color: #FBBF24;
        }
        .converter-select {
            width: 100%;
            background-color: #374151;
            border: none;
            color: #F3F4F6;
            font-weight: 500;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .swap-btn {
            background-color: #4b5563;
            border-radius: 9999px;
            padding: 0.75rem;
            color: #FBBF24;
            border: 2px solid #374151;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }
        .swap-btn:hover {
            background-color: #6b7280;
            transform: rotate(180deg);
        }
        #rate-display {
            min-height: 1.25rem; /* h-5 */
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-100">

    <!-- Splash Screen -->
    <div id="splash-screen" class="splash-screen">
        <div class="flex-grow flex items-center justify-center text-center">
            <div>
                 <h1 class="text-5xl font-poppins">
                    <span class="text-white font-bold trade-line">Trade</span><span class="font-normal" style="color: #FBBF24;">folio</span>
                </h1>
                <p class="text-sm text-gray-400 mt-2">il tuo diario di trading con IA integrata</p>
            </div>
        </div>
        <div id="auth-container" class="pb-4 w-full max-w-sm px-4">
            <!-- Auth form will be rendered here by JS -->
        </div>
    </div>

    <div id="menu-overlay"></div>
    <div id="side-menu" class="side-menu"></div>

    <div id="app-container" class="min-h-screen flex flex-col">
        <!-- Header Fisso in Alto -->
        <header class="sticky top-0 z-50 bg-gray-800/70 backdrop-blur-lg border-b border-gray-700">
            <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
                 <div class="flex justify-between items-center">
                     <h1 class="text-2xl font-poppins">
                         <span class="text-white font-bold trade-line">Trade</span><span class="font-normal" style="color: #FBBF24;">folio</span>
                     </h1>
                     <button data-action="toggle-menu" class="p-2 rounded-md text-gray-300 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                 </div>
                <div id="header-actions" class="flex justify-center items-start gap-2 mt-3">
                    <!-- I pulsanti dell'header verranno renderizzati qui da JS -->
                </div>
            </div>
        </header>

        <!-- Contenuto Principale (scorrevole) -->
        <main class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Selettore Mese/Anno -->
            <div class="flex justify-center items-center gap-1 sm:gap-2 mb-6 w-full">
                <button data-action="prev-year" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold p-2 rounded-lg text-xs sm:text-sm transition-colors">&lt;&lt;</button>
                <button data-action="prev-month" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold p-2 rounded-lg text-xs sm:text-sm transition-colors">&lt;</button>
                <span id="current-month-year" class="text-base sm:text-lg font-bold text-gray-100 min-w-[140px] sm:min-w-[160px] text-center"></span>
                <button data-action="next-month" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold p-2 rounded-lg text-xs sm:text-sm transition-colors">&gt;</button>
                <button data-action="next-year" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold p-2 rounded-lg text-xs sm:text-sm transition-colors">&gt;&gt;</button>
            </div>
            
            <!-- Contenitore Calendario e Grafico -->
            <div id="calendar-container" class="pb-28"></div>
        </main>
        
        <!-- Ticker Fisso in Basso -->
        <div id="ticker-container" class="fixed bottom-16 left-0 right-0 z-40"></div>

        <!-- Barra di Navigazione Inferiore Fissa -->
        <nav class="fixed bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-lg border-t border-gray-700 z-50">
            <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="bottom-nav-content" class="relative flex justify-between items-center h-16">
                     <!-- Il contenuto della navigazione inferiore verrÃ  renderizzato qui da JS -->
                </div>
            </div>
        </nav>
    </div>

    <!-- Contenitore per i Modali -->
    <div id="modals-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDoNfXrcofobe3NvSFdrzhqlmGgQT-7qWY",
          authDomain: "tradefolio-2c387.firebaseapp.com",
          projectId: "tradefolio-2c387",
          storageBucket: "tradefolio-2c387.appspot.com",
          messagingSenderId: "119467817034",
          appId: "1:119467817034:web:d1b1e7f0726847fb0b8eb3",
          measurementId: "G-L762CP81GC"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let state = {
                trades: [],
                notes: [],
                alerts: [], 
                currentYear: new Date().getFullYear(),
                currentMonthIndex: new Date().getMonth(),
                tickerData: [],
                fiatRates: null,
                apiKey: 'AIzaSyBXkdQjsy5xR6KcFz-Gcqijqh9NTjliT6o', // API Key per Gemini
                gnewsApiKey: '35d4490e629113e4a2efd30e1eac76b1', // API Key per GNews
                modal: { isOpen: false, mode: null, data: null },
                noteModal: { isOpen: false, date: null, text: '' },
                confirmationModal: { isOpen: false, message: '', onConfirm: null },
                infoModal: { isOpen: false, title: '', content: '', isLoading: false },
                converterModal: { isOpen: false },
                iframeModal: { isOpen: false, url: '', title: '' },
                isMenuOpen: false,
                auth: { mode: 'login', error: null, isLoading: false },
                currentCurrency: 'usd',
                supportedCurrencies: [
                    { code: 'usd', symbol: '$', name: 'Dollaro USA' },
                    { code: 'eur', symbol: 'â‚¬', name: 'Euro' },
                    { code: 'gbp', symbol: 'Â£', name: 'Sterlina Inglese' },
                    { code: 'jpy', symbol: 'Â¥', name: 'Yen Giapponese' },
                    { code: 'aud', symbol: 'A$', name: 'Dollaro Australiano' },
                    { code: 'cad', symbol: 'C$', name: 'Dollaro Canadese' },
                    { code: 'chf', symbol: 'Fr', name: 'Franco Svizzero' },
                    { code: 'cny', symbol: 'Â¥', name: 'Yuan Cinese' }
                ],
                fiatForConverter: [
                    { code: 'EUR', symbol: 'â‚¬', name: 'Euro' },
                    { code: 'USD', symbol: '$', name: 'Dollaro USA' },
                    { code: 'CHF', symbol: 'Fr', name: 'Franco Svizzero' },
                    { code: 'GBP', symbol: 'Â£', name: 'Sterlina Inglese' },
                    { code: 'JPY', symbol: 'Â¥', name: 'Yen Giapponese' },
                ],
                currentLanguage: 'it',
                supportedLanguages: [
                    { code: 'it', name: 'Italiano', shortName: 'ITA' },
                    { code: 'en', name: 'English', shortName: 'ENG' },
                    { code: 'de', name: 'Deutsch', shortName: 'DEU' },
                    { code: 'fr', name: 'FranÃ§ais', shortName: 'FRA' },
                ],
                user: null,
                tradesListener: null,
                notesListener: null,
            };
            let profitChart = null;

            // --- TRANSLATIONS ---
            const translations = {
                it: {
                    monthNames: ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'],
                    dayNames: ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'],
                    aiAnalysis: 'Analisi AI',
                    calendar: 'Calendario',
                    news: 'Notizie',
                    report: 'Report',
                    yearlyReport: 'Report Annuale',
                    summary: 'Riepilogo',
                    monthActivity: "AttivitÃ  del Mese",
                    open: 'Apri',
                    close: 'Chiudi',
                    other: 'Altro',
                    downloadCSV: 'Scarica Report CSV',
                    infoAndTerms: 'Info & Termini',
                    netProfit: 'Guadagno Netto',
                    day: 'Giorno',
                    tickerOffline: 'Ticker non disponibile offline.',
                    loadingPrices: 'Caricamento prezzi...',
                    openNewPosition: 'Apri Nuova Posizione',
                    closePosition: 'Chiudi Posizione',
                    editTransaction: 'Modifica Transazione',
                    selectCrypto: 'Seleziona una criptovaluta',
                    purchasePrice: 'Prezzo Acquisto',
                    quantity: 'QuantitÃ ',
                    leverage: 'Usa Leva',
                    savePosition: 'Salva Posizione',
                    selectPosition: 'Seleziona posizione',
                    salePrice: 'Prezzo Vendita',
                    closePositionBtn: 'Chiudi Posizione',
                    cryptoSymbol: 'Simbolo Crypto',
                    purchaseDate: 'Data Acquisto',
                    saleDate: 'Data Vendita',
                    saveChanges: 'Salva Modifiche',
                    confirmRequest: 'Conferma Richiesta',
                    deleteConfirmMsg: "Sei sicuro di voler eliminare questa transazione? L'azione Ã¨ irreversibile.",
                    cancel: 'Annulla',
                    confirm: 'Conferma',
                    searchingRealTimeNews: 'Ricerca notizie in tempo reale...',
                    latestFinancialNews: 'Ultime Notizie Finanziarie',
                    error: 'Errore',
                    errorLoadingNews: "Impossibile caricare le notizie in questo momento.",
                    loadingCalendar: 'Caricamento Calendario...',
                    economicCalendar: 'Calendario Economico',
                    errorLoadingCalendar: "Impossibile caricare il calendario in questo momento.",
                    noTradesToAnalyze: "Nessuna operazione chiusa in questo mese da analizzare.",
                    monthlyReportFor: "Report Mensile di",
                    yearlyReportFor: "Report Annuale per il",
                    noTradesThisMonth: "Nessuna operazione chiusa in questo mese.",
                    noTradesThisYear: "Nessuna operazione chiusa in quest'anno.",
                    termsAndConditions: "Termini e Condizioni",
                    edit: "Edita",
                    delete: "Elimina",
                    converter: "Convertitore",
                    currencyConverter: "Convertitore di Valute",
                    from: "Da",
                    to: "A",
                    amount: "Importo",
                    fromCache: "(dalla cache)",
                    searchingLive: "Ricerca dati in tempo reale...",
                    fiatCurrencies: "Valute Fiat",
                    cryptoCurrencies: "Criptovalute",
                    login: "Accedi",
                    register: "Registrati",
                    email: "Email",
                    password: "Password",
                    noAccount: "Non hai un account?",
                    haveAccount: "Hai giÃ  un account?",
                    signOut: "Esci",
                    rememberMe: "Rimani connesso",
                    note: "Nota",
                    saveNote: "Salva Nota",
                    noteFor: "Nota per il",
                    highImpactEvents: "Eventi ad Alto Impatto",
                    statisticalWarning: "Avviso Statistico",
                    statisticalWarningMessage: "Questo giorno Ã¨ statisticamente soggetto a maggiore volatilitÃ  a causa degli assestamenti di portafoglio di fine mese.",
                    todaysAlerts: "Avvisi di Oggi"
                },
                en: {
                    monthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                    dayNames: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                    aiAnalysis: 'AI Analysis',
                    calendar: 'Calendar',
                    news: 'News',
                    report: 'Report',
                    yearlyReport: 'Yearly Report',
                    summary: 'Summary',
                    monthActivity: "Month's Activity",
                    open: 'Open',
                    close: 'Close',
                    other: 'More',
                    downloadCSV: 'Download CSV Report',
                    infoAndTerms: 'Info & Terms',
                    netProfit: 'Net Profit',
                    day: 'Day',
                    tickerOffline: 'Ticker unavailable offline.',
                    loadingPrices: 'Loading prices...',
                    openNewPosition: 'Open New Position',
                    closePosition: 'Close Position',
                    editTransaction: 'Edit Transaction',
                    selectCrypto: 'Select a cryptocurrency',
                    purchasePrice: 'Purchase Price',
                    quantity: 'Quantity',
                    leverage: 'Use Leverage',
                    savePosition: 'Save Position',
                    selectPosition: 'Select position',
                    salePrice: 'Sale Price',
                    closePositionBtn: 'Close Position',
                    cryptoSymbol: 'Crypto Symbol',
                    purchaseDate: 'Purchase Date',
                    saleDate: 'Sale Date',
                    saveChanges: 'Save Changes',
                    confirmRequest: 'Confirm Request',
                    deleteConfirmMsg: "Are you sure you want to delete this transaction? This action is irreversible.",
                    cancel: 'Cancel',
                    confirm: 'Confirm',
                    searchingRealTimeNews: 'Searching for real-time news...',
                    latestFinancialNews: 'Latest Financial News',
                    error: 'Error',
                    errorLoadingNews: "Could not load news at this time.",
                    loadingCalendar: 'Loading Calendar...',
                    economicCalendar: 'Economic Calendar',
                    errorLoadingCalendar: "Could not load the calendar at this time.",
                    noTradesToAnalyze: "No closed trades in this month to analyze.",
                    monthlyReportFor: "Monthly Report for",
                    yearlyReportFor: "Yearly Report for",
                    noTradesThisMonth: "No closed trades in this month.",
                    noTradesThisYear: "No closed trades in this year.",
                    termsAndConditions: "Terms and Conditions",
                    edit: "Edit",
                    delete: "Delete",
                    converter: "Converter",
                    currencyConverter: "Currency Converter",
                    from: "From",
                    to: "To",
                    amount: "Amount",
                    fromCache: "(from cache)",
                    searchingLive: "Searching for live data...",
                    fiatCurrencies: "Fiat Currencies",
                    cryptoCurrencies: "Cryptocurrencies",
                    login: "Login",
                    register: "Register",
                    email: "Email",
                    password: "Password",
                    noAccount: "Don't have an account?",
                    haveAccount: "Already have an account?",
                    signOut: "Sign Out",
                    rememberMe: "Stay logged in",
                    note: "Note",
                    saveNote: "Save Note",
                    noteFor: "Note for",
                    highImpactEvents: "High-Impact Events",
                    statisticalWarning: "Statistical Warning",
                    statisticalWarningMessage: "This day is statistically subject to higher volatility due to end-of-month portfolio rebalancing.",
                    todaysAlerts: "Today's Alerts"
                },
            };

            const t = (key) => {
                return translations[state.currentLanguage]?.[key] || translations['it'][key] || key;
            };
            
            // --- FIRESTORE FUNCTIONS ---
            function setupTradesListener(userId) {
                if (state.tradesListener) state.tradesListener();
                const tradesCollection = collection(db, "users", userId, "trades");
                state.tradesListener = onSnapshot(tradesCollection, (snapshot) => {
                    state.trades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                });
            }

            function setupNotesListener(userId) {
                if (state.notesListener) state.notesListener();
                const notesCollection = collection(db, "users", userId, "notes");
                state.notesListener = onSnapshot(notesCollection, (snapshot) => {
                    state.notes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                });
            }

            async function saveNote(date, text) {
                if (!state.user) return;
                const noteRef = doc(db, "users", state.user.uid, "notes", date);
                if (text.trim() === '') {
                    await deleteDoc(noteRef);
                } else {
                    await setDoc(noteRef, { text: text });
                }
            }

            async function addTrade(tradeData) {
                if (!state.user) return;
                await addDoc(collection(db, "users", state.user.uid, "trades"), tradeData);
            }

            async function updateTrade(tradeId, tradeData) {
                if (!state.user) return;
                const tradeRef = doc(db, "users", state.user.uid, "trades", tradeId);
                await updateDoc(tradeRef, tradeData);
            }

            async function deleteTrade(tradeId) {
                if (!state.user) return;
                await deleteDoc(doc(db, "users", state.user.uid, "trades", tradeId));
            }

            // --- LOCAL SETTINGS FUNCTIONS ---
            function loadSettings() {
                const savedSettings = localStorage.getItem('tradefolioSettings');
                if(savedSettings) {
                    try {
                        const settings = JSON.parse(savedSettings);
                        state.currentCurrency = settings.currentCurrency || 'usd';
                        state.currentLanguage = settings.currentLanguage || 'it';
                    } catch (e) { console.error("Could not parse settings", e); }
                }
            }
            function saveSettings() {
                const settings = { 
                    currentCurrency: state.currentCurrency,
                    currentLanguage: state.currentLanguage 
                };
                localStorage.setItem('tradefolioSettings', JSON.stringify(settings));
            }
            
            // --- UTILITY & CONVERSION FUNCTIONS ---
            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const formatDate = (dateStr) => { if (!dateStr) return ''; const [y, m, d] = dateStr.split('-'); return `${d}/${m}/${y}`; };
            const getCurrencySymbol = () => (state.supportedCurrencies.find(c => c.code === state.currentCurrency) || {symbol: '$'}).symbol;

            const convertToCurrentCurrency = (amountInUSD) => {
                if (!state.fiatRates || !state.currentCurrency || !amountInUSD) return amountInUSD;
                const rate = state.fiatRates[state.currentCurrency.toUpperCase()];
                return rate ? amountInUSD * rate : amountInUSD;
            };

            const convertFromCurrentCurrencyToUSD = (amount) => {
                if (!state.fiatRates || !state.currentCurrency || !amount) return amount;
                const rate = state.fiatRates[state.currentCurrency.toUpperCase()];
                return rate ? amount / rate : amount;
            };

            const calculateTradeProfits = (trade) => {
                if (trade.status !== 'closed' || !trade.salePrice) return { ...trade, netProfit: 0, percentageProfit: 0 };
                const leverage = trade.leverage || 1; 
                const netProfit = (trade.salePrice - trade.purchasePrice) * trade.quantity * leverage;
                const costBasis = trade.purchasePrice * trade.quantity; 
                const percentageProfit = costBasis !== 0 ? (netProfit / costBasis) * 100 : 0;
                return { ...trade, netProfit, percentageProfit };
            };
            
            // --- NUOVA FUNZIONE PER AVVISI STATISTICI ---
            function getStatisticalAlertForDate(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const dayOfMonth = date.getDate();

                let lastDayOfMonth = new Date(year, month + 1, 0);
                let tradingDaysFound = 0;
                
                for (let i = 0; i < 5; i++) {
                    let checkDate = new Date(lastDayOfMonth);
                    checkDate.setDate(lastDayOfMonth.getDate() - i);
                    let dayOfWeek = checkDate.getDay();

                    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Esclude Sabato e Domenica
                        tradingDaysFound++;
                        if (checkDate.getDate() === dayOfMonth && tradingDaysFound <= 2) {
                            return {
                                title: t('statisticalWarning'),
                                message: t('statisticalWarningMessage')
                            };
                        }
                    }
                }
                return null;
            }

            // --- UI UPDATE FUNCTIONS ---
            function rerenderDay(dateString) {
                const dayColumn = document.querySelector(`.day-column[data-date="${dateString}"]`);
                if (!dayColumn) return;

                const { trades, notes } = state;
                const currencySymbol = getCurrencySymbol();
                const closedOnThisDay = trades.filter(t => t.saleDate === dateString);
                const openedOnThisDay = trades.filter(t => t.purchaseDate === dateString && t.status === 'open');

                const tradesHTML = `
                    ${closedOnThisDay.map(trade => {
                        const p = calculateTradeProfits(trade);
                        const displayProfit = convertToCurrentCurrency(p.netProfit);
                        return `<div class="trade-item bg-gray-800 flex flex-col p-2 mt-2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold text-base text-white">${trade.cryptoSymbol.toUpperCase()} ${trade.leverage > 1 ? `<span class="text-xs font-normal text-yellow-400">${trade.leverage}x</span>` : ''}</div>
                                    <div class="text-sm mt-1">
                                        ${displayProfit >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰'} <span class="${displayProfit >= 0 ? 'profit' : 'loss'}">${displayProfit.toFixed(2)} ${currencySymbol}</span>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400">(${p.percentageProfit.toFixed(1)}%)</div>
                            </div>
                            <div class="trade-actions mt-2 self-end">
                                <button class="action-btn bg-green-600 hover:bg-green-700" data-action="open-modal" data-mode="edit_closed" data-trade-id="${trade.id}">${t('edit')}</button>
                                <button class="action-btn bg-red-600 hover:bg-red-700" data-action="delete-trade" data-trade-id="${trade.id}">${t('delete')}</button>
                            </div>
                        </div>`}).join('')}
                    ${openedOnThisDay.map(trade => {
                        const displayPrice = convertToCurrentCurrency(trade.purchasePrice);
                        return `<div class="trade-item bg-gray-700/50 flex flex-col p-2 mt-2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold text-base text-white">${trade.cryptoSymbol.toUpperCase()} ${trade.leverage > 1 ? `<span class="text-xs font-normal text-yellow-400">${trade.leverage}x</span>` : ''}</div>
                                    <div class="text-sm mt-1 text-gray-300">
                                        <span>${trade.quantity} @ ${displayPrice.toFixed(2)}${currencySymbol}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="trade-actions mt-2 self-end">
                                <button class="action-btn bg-green-600 hover:bg-green-700" data-action="open-modal" data-mode="edit_open" data-trade-id="${trade.id}">${t('edit')}</button>
                                <button class="action-btn bg-red-600 hover:bg-red-700" data-action="delete-trade" data-trade-id="${trade.id}">${t('delete')}</button>
                            </div>
                        </div>`}).join('')}
                `;
                
                const note = notes.find(n => n.id === dateString);
                const noteIconSVG = note ?
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>` :
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>`;

                const noteButtonHTML = `
                    <div class="mt-2 border-t border-gray-600 pt-2">
                        <button data-action="open-note-modal" data-date="${dateString}" class="w-full flex items-center justify-center gap-2 text-xs text-gray-300 hover:bg-gray-600 p-1 rounded-md transition-colors">
                            ${noteIconSVG}
                            <span>${t('note')}</span>
                        </button>
                    </div>`;

                const tradeContainer = dayColumn.querySelector('.trade-container');
                if (tradeContainer) tradeContainer.innerHTML = tradesHTML;
                
                const noteContainer = dayColumn.querySelector('.note-container');
                if (noteContainer) noteContainer.innerHTML = noteButtonHTML;
            }

            // --- RENDER FUNCTIONS (COMPONENTI SPECIFICI) ---

            function render() {
                if (state.user) {
                    const currentTranslations = translations[state.currentLanguage] || translations['it'];
                    const monthNames = currentTranslations.monthNames;
                    document.documentElement.lang = state.currentLanguage;
                    document.getElementById('header-actions').innerHTML = renderHeaderActions();
                    document.getElementById('bottom-nav-content').innerHTML = renderBottomNav();
                    document.getElementById('ticker-container').innerHTML = renderTicker();
                    document.getElementById('current-month-year').textContent = `${monthNames[state.currentMonthIndex]} ${state.currentYear}`;
                    document.getElementById('calendar-container').innerHTML = renderCalendar();
                    document.getElementById('summary-bubble').innerHTML = renderSummaryBubble();
                    const navCloseBtn = document.getElementById('nav-close-btn');
                    if(navCloseBtn) {
                        navCloseBtn.disabled = state.trades.filter(t => t.status === 'open').length === 0;
                    }
                    renderSideMenu();
                    renderChart(); 
                } else {
                    document.getElementById('auth-container').innerHTML = renderAuthForm();
                }
                document.getElementById('modals-container').innerHTML = renderAllModals();

                const menu = document.getElementById('side-menu');
                const overlay = document.getElementById('menu-overlay');
                if (menu && overlay) {
                    menu.classList.toggle('open', state.isMenuOpen);
                    overlay.classList.toggle('open', state.isMenuOpen);
                }
            }

            function renderAuthForm() {
                const { mode, error, isLoading } = state.auth;
                const isLogin = mode === 'login';

                return `
                    <form id="auth-form" class="space-y-4">
                        <input type="email" id="auth-email" placeholder="${t('email')}" required class="modal-input">
                        <input type="password" id="auth-password" placeholder="${t('password')}" required class="modal-input">
                        
                        ${isLogin ? `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input id="stay-logged-in" name="stay-logged-in" type="checkbox" class="h-4 w-4 text-yellow-500 focus:ring-yellow-400 border-gray-500 rounded bg-gray-700">
                                <label for="stay-logged-in" class="ml-2 block text-sm text-gray-300">${t('rememberMe')}</label>
                            </div>
                        </div>
                        ` : ''}

                        ${error ? `<p class="text-red-400 text-sm text-center">${error}</p>` : ''}

                        <button type="submit" class="modal-btn w-full ${isLogin ? 'bg-yellow-500 hover:bg-yellow-600 text-black' : 'bg-gray-600 hover:bg-gray-500 text-white'}" ${isLoading ? 'disabled' : ''}>
                            ${isLoading ? `<div class="loader !w-6 !h-6 !border-4"></div>` : (isLogin ? t('login') : t('register'))}
                        </button>
                    </form>
                    <p class="text-center text-sm text-gray-400 mt-4">
                        ${isLogin ? t('noAccount') : t('haveAccount')}
                        <button data-action="toggle-auth-form" class="font-semibold text-yellow-400 hover:underline">${isLogin ? t('register') : t('login')}</button>
                    </p>
                    <p class="text-xs text-gray-500 mt-8 text-center whitespace-nowrap">Copyright Â© 2025 Fabio Amendola. Tutti i diritti riservati. ver. 6.10</p>
                `;
            }

            function renderHeaderActions() {
                return `
                    <button class="flex flex-col items-center w-16 text-gray-300 hover:text-white transition-colors" data-action="fetch-ai-analysis" aria-label="${t('aiAnalysis')}">
                       <div class="h-6 w-6 flex items-center justify-center">
                            <span class="text-xl">ðŸ’¡</span>
                       </div>
                       <span class="text-xs mt-1">A.I</span>
                    </button>
                    <button class="flex flex-col items-center w-16 text-gray-300 hover:text-white transition-colors" data-action="fetch-economic-calendar" aria-label="${t('calendar')}">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 256 256"><path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32ZM208,48V72H48V48ZM48,208V88H208V208Z"></path></svg>
                       <span class="text-xs mt-1">${t('calendar')}</span>
                    </button>
                    <button class="flex flex-col items-center w-16 text-gray-300 hover:text-white transition-colors" data-action="fetch-news" aria-label="${t('news')}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 256 256"><path d="M208,24H72A16,16,0,0,0,56,40V216a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V40A16,16,0,0,0,208,24Zm0,192H72V40H208V216ZM40,56H24A16,16,0,0,0,8,72V200a16,16,0,0,0,16,16H40a8,8,0,0,0,0-16H32V72H40a8,8,0,0,0,0-16ZM104,80a8,8,0,0,1,8-8h80a8,8,0,0,1,0,16H112A8,8,0,0,1,104,80Zm88,40H112a8,8,0,0,0,0,16h80a8,8,0,0,0,0-16Zm0,48H112a8,8,0,0,0,0,16h80a8,8,0,0,0,0-16Z"></path></svg>
                        <span class="text-xs mt-1">${t('news')}</span>
                    </button>
                    <button class="flex flex-col items-center w-16 text-gray-300 hover:text-white transition-colors" data-action="generate-monthly-report" aria-label="${t('report')}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a96,96,0,1,1-96-96A96,96,0,0,1,224,128ZM128,56v96h96A72.08,72.08,0,0,0,128,56Z"></path></svg>
                        <span class="text-xs mt-1">${t('report')}</span>
                    </button>
                `;
            }

            function renderBottomNav() {
                return `
                    <button data-action="open-modal" data-mode="open" class="flex flex-col items-center justify-center h-full w-1/4 text-green-400 hover:text-green-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="text-xs font-medium">${t('open')}</span>
                    </button>
                    
                    <div id="summary-bubble" class="absolute left-1/2 top-0 -translate-x-1/2 -translate-y-1/2 z-10"></div>

                    <button data-action="open-modal" data-mode="close" id="nav-close-btn" class="flex flex-col items-center justify-center h-full w-1/4 text-red-400 hover:text-red-300 transition-colors disabled:text-gray-500 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="text-xs font-medium">${t('close')}</span>
                    </button>
                `;
            }

            function renderTicker() {
                if (!navigator.onLine && state.tickerData.length === 0) {
                     return `<div class="ticker-wrap"><div class="ticker-item">${t('tickerOffline')}</div></div>`;
                }
                if (state.tickerData.length === 0) return `<div class="ticker-wrap"><div class="ticker-item">${t('loadingPrices')}</div></div>`;
                const currencySymbol = getCurrencySymbol();
                const items = state.tickerData.map(coin => {
                    const displayPrice = convertToCurrentCurrency(coin.current_price);
                    return `
                    <span class="ticker-item">
                        <img src="${coin.image}" alt="${coin.name}" class="w-4 h-4"/>
                        ${coin.name}: <span class="${coin.price_change_percentage_24h >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${currencySymbol}${displayPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </span>
                    </span>
                `}).join('');
                return `<div class="ticker-wrap"><div class="ticker-move">${items}${items}</div></div>`;
            }
            
            function renderSummaryBubble() {
                const { currentYear, currentMonthIndex, trades } = state;
                const monthKey = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}`;
                const tradesInMonth = trades.filter(t => t.status === 'closed' && t.saleDate && t.saleDate.startsWith(monthKey));
                const monthNetProfitUSD = tradesInMonth.reduce((acc, t) => acc + (calculateTradeProfits(t).netProfit || 0), 0);
                const displayProfit = convertToCurrentCurrency(monthNetProfitUSD);
                
                return `
                    <div class="bg-gray-900 rounded-full w-32 h-16 flex flex-col justify-center items-center border-2 border-gray-700">
                        <span class="text-xs text-gray-400">${t('summary')}</span>
                        <span class="font-bold text-sm ${displayProfit >= 0 ? 'profit' : 'loss'}">${displayProfit.toFixed(2)} ${getCurrencySymbol()}</span>
                    </div>
                `;
            }

            function renderCalendar() {
                const { currentYear, currentMonthIndex, alerts } = state;
                const currentTranslations = translations[state.currentLanguage] || translations['it'];
                const dayNames = currentTranslations.dayNames;
                const daysInMonth = getDaysInMonth(currentYear, currentMonthIndex);
                
                const chartHTML = `<div class="w-full h-48 md:h-64 mb-4"><canvas id="profitChart"></canvas></div>`;
                let columnsHTML = '';
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, currentMonthIndex, day);
                    const dayOfWeek = date.getDay();
                    const dayName = dayNames[dayOfWeek];
                    const isSunday = dayOfWeek === 0;
                    const sundayClass = isSunday ? 'border-red-500/50' : '';

                    const dateString = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    const dayAlert = alerts.find(a => a.date === dateString);
                    const alertIconHTML = dayAlert 
                        ? `<button data-action="show-alert-info" data-date="${dateString}" class="p-0 bg-transparent border-none cursor-pointer"><span class="text-base">âš ï¸</span></button>` 
                        : '';
                    
                    const statisticalAlert = getStatisticalAlertForDate(date);
                    const statisticalAlertIconHTML = statisticalAlert
                        ? `<button data-action="show-statistical-alert" data-date="${dateString}" class="p-0 bg-transparent border-none cursor-pointer"><span class="text-base">â›”ï¸</span></button>`
                        : '';

                    columnsHTML += `
                        <div class="day-column ${sundayClass}" data-date="${dateString}">
                            <div class="flex justify-between items-center pb-2 border-b border-gray-600">
                                <div class="flex items-center gap-2">
                                    <div class="font-bold text-xl text-white">${day}</div>
                                    ${alertIconHTML}
                                    ${statisticalAlertIconHTML}
                                </div>
                                <div class="text-sm text-gray-400">${dayName}</div>
                            </div>
                            <div class="flex-grow trade-container"></div>
                            <div class="note-container"></div>
                        </div>
                    `;
                }

                const activityHTML = `
                    <div class="bg-gray-700 p-4 rounded-xl shadow-lg w-full text-gray-100">
                        <div class="flex justify-between items-center mb-3 border-b border-gray-600 pb-2">
                            <h4 class="text-md font-bold text-white">${t('monthActivity')}</h4>
                        </div>
                        <div class="horizontal-calendar-wrapper">
                            <div class="horizontal-calendar-content">
                                ${columnsHTML}
                            </div>
                        </div>
                    </div>
                `;

                const summaryAndChartHTML = `
                    <div class="bg-gray-700 p-4 rounded-xl shadow-lg w-full text-gray-100 mb-4">
                        ${chartHTML}
                    </div>
                `;
                
                setTimeout(() => {
                     for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        rerenderDay(dateString);
                    }
                }, 0);

                return summaryAndChartHTML + activityHTML;
            }

            function renderChart() {
                const chartCanvas = document.getElementById('profitChart');
                if (!chartCanvas) return;
                const ctx = chartCanvas.getContext('2d');
                
                const { currentYear, currentMonthIndex, trades } = state;
                const currencySymbol = getCurrencySymbol();
                const daysInMonth = getDaysInMonth(currentYear, currentMonthIndex);
                const closedTrades = trades.filter(t => t.status === 'closed');
                const dailySummaries = new Map();

                closedTrades.forEach(trade => {
                    const saleDate = trade.saleDate;
                    if (!saleDate || !saleDate.startsWith(`${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}`)) return;
                    if (!dailySummaries.has(saleDate)) { dailySummaries.set(saleDate, { netProfit: 0 }); }
                    dailySummaries.get(saleDate).netProfit += (calculateTradeProfits(trade).netProfit || 0);
                });

                const chartData = Array.from({ length: daysInMonth }, (_, day) => {
                    const dateString = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day + 1).padStart(2, '0')}`;
                    const profitUSD = dailySummaries.get(dateString)?.netProfit || 0;
                    return convertToCurrentCurrency(profitUSD);
                });
                
                const chartLabels = Array.from({ length: daysInMonth }, (_, day) => day + 1);

                const backgroundColors = chartData.map(profit => profit >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)');
                const hoverBackgroundColors = chartData.map(profit => profit >= 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)');

                if (profitChart) { profitChart.destroy(); }
                
                profitChart = new Chart(ctx, {
                    type: 'bar',
                    data: { 
                        labels: chartLabels, 
                        datasets: [{ 
                            label: t('netProfit'), 
                            data: chartData, 
                            backgroundColor: backgroundColors,
                            hoverBackgroundColor: hoverBackgroundColors,
                            borderColor: backgroundColors,
                            borderWidth: 1,
                            borderRadius: 4,
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { 
                                ticks: { color: '#9CA3AF', font: { size: 10 } }, 
                                grid: { color: '#4b5563' } 
                            }, 
                            x: { 
                                ticks: { color: '#9CA3AF', font: { size: 10 } }, 
                                grid: { display: false } 
                            } 
                        }, 
                        plugins: { 
                            legend: { display: false }, 
                            tooltip: { 
                                backgroundColor: '#1f2937', 
                                titleColor: '#F3F4F6', 
                                bodyColor: '#D1D5DB', 
                                callbacks: { 
                                    label: (c) => `${t('day')} ${c.label}: ${c.raw.toFixed(2)} ${currencySymbol}` 
                                } 
                            } 
                        } 
                    }
                });
            }
            
            function renderAllModals() {
                let html = '';
                if (state.modal.isOpen) html += renderTradeModal();
                if (state.noteModal.isOpen) html += renderNoteModal();
                if (state.confirmationModal.isOpen) html += renderConfirmationModal();
                if (state.infoModal.isOpen) html += renderInfoModal();
                if (state.converterModal.isOpen) html += renderConverterModal();
                if (state.iframeModal.isOpen) html += renderIframeModal();
                return html;
            }

            function renderTradeModal() {
                const { mode, data } = state.modal;
                const currencySymbol = getCurrencySymbol();
                let content = '';
                const today = new Date().toISOString().split('T')[0];

                if (mode === 'open') {
                    const cryptoOptions = state.tickerData.map(coin => `<option value="${coin.symbol.toUpperCase()}">${coin.name} (${coin.symbol.toUpperCase()})</option>`).join('');
                    content = `<h2 class="text-lg font-bold mb-3 text-white">${t('openNewPosition')}</h2>
                               <div class="space-y-3">
                                   <input id="open-date" type="date" value="${today}" required class="modal-input" />
                                   <select id="open-crypto-select" required class="modal-input">
                                       <option value="" disabled selected>${t('selectCrypto')}</option>
                                       ${cryptoOptions}
                                   </select>
                                   <input id="open-price" type="number" step="any" placeholder="${t('purchasePrice')} (${currencySymbol})" required class="modal-input" />
                                   <input id="open-quantity" type="number" step="any" placeholder="${t('quantity')}" required class="modal-input" />
                                   <div class="flex items-center gap-2 pt-2">
                                        <input type="checkbox" id="open-leverage-toggle" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-yellow-500 focus:ring-yellow-400">
                                        <label for="open-leverage-toggle" class="text-sm font-medium text-gray-300">${t('leverage')}</label>
                                   </div>
                                   <div id="open-leverage-container" class="flex items-center gap-4 opacity-50 transition-opacity">
                                        <input id="open-leverage-slider" type="range" min="1" max="100" value="1" class="custom-slider flex-grow" disabled>
                                        <span id="open-leverage-display" class="font-bold text-lg text-yellow-400 w-16 text-center">1x</span>
                                   </div>
                                   <input type="hidden" id="open-leverage" value="1">
                               </div>
                               <div class="flex justify-end mt-4">
                                   <button type="submit" class="modal-btn bg-yellow-500 hover:bg-yellow-600 text-black">${t('savePosition')}</button>
                               </div>`;
                } else if (mode === 'close') {
                    const openPositions = state.trades.filter(t => t.status === 'open');
                    const openPositionsOptions = openPositions.map(t => {
                        const displayPrice = convertToCurrentCurrency(t.purchasePrice);
                        return `<option value="${t.id}">${t.cryptoSymbol.toUpperCase()} (${t.quantity}) del ${formatDate(t.purchaseDate)} @ ${displayPrice.toFixed(2)}${currencySymbol}</option>`;
                    }).join('');
                    content = `<h2 class="text-lg font-bold mb-3 text-white">${t('closePosition')}</h2>
                               <div class="space-y-3">
                                   <select id="close-trade-select" required class="modal-input">
                                       <option value="">${t('selectPosition')}</option>
                                       ${openPositionsOptions}
                                   </select>
                                   <input id="close-date" type="date" value="${today}" required class="modal-input" />
                                   <input id="close-price" type="number" step="any" placeholder="${t('salePrice')} (${currencySymbol})" required class="modal-input" />
                               </div>
                               <div class="flex justify-end mt-4">
                                   <button type="submit" class="modal-btn bg-red-600 hover:bg-red-700 text-white">${t('closePositionBtn')}</button>
                               </div>`;
                } else if (mode === 'edit_open' || mode === 'edit_closed') {
                    const trade = state.trades.find(t => t.id === data.tradeId);
                    const displayPurchasePrice = convertToCurrentCurrency(trade.purchasePrice);
                    const displaySalePrice = trade.salePrice ? convertToCurrentCurrency(trade.salePrice) : '';
                    const currentLeverage = trade.leverage || 1;

                    content = `<h2 class="text-lg font-bold mb-3 text-white">${t('editTransaction')}</h2>
                               <div class="space-y-3 text-sm">
                                   <label class="block">${t('cryptoSymbol')} <input id="edit-crypto-symbol" type="text" value="${trade.cryptoSymbol}" required class="modal-input mt-1" /></label>
                                   <label class="block">${t('purchaseDate')} <input id="edit-purchase-date" type="date" value="${trade.purchaseDate}" class="modal-input mt-1" /></label>
                                   ${mode === 'edit_closed' ? `<label class="block">${t('saleDate')} <input id="edit-sale-date" type="date" value="${trade.saleDate}" class="modal-input mt-1" /></label>` : ''}
                                   <label class="block">${t('purchasePrice')} (${currencySymbol})<input id="edit-purchase-price" type="number" step="any" value="${displayPurchasePrice.toFixed(5)}" class="modal-input mt-1" /></label>
                                   ${mode === 'edit_closed' ? `<label class="block">${t('salePrice')} (${currencySymbol})<input id="edit-sale-price" type="number" step="any" value="${displaySalePrice.toFixed(5)}" class="modal-input mt-1" /></label>` : ''}
                                   <label class="block">${t('quantity')} <input id="edit-quantity" type="number" step="any" value="${trade.quantity}" class="modal-input mt-1" /></label>
                                   ${mode === 'edit_open' ? `
                                       <div class="flex items-center gap-2 pt-2">
                                            <input type="checkbox" id="edit-leverage-toggle" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-yellow-500 focus:ring-yellow-400" ${currentLeverage > 1 ? 'checked' : ''}>
                                            <label for="edit-leverage-toggle" class="text-sm font-medium text-gray-300">${t('leverage')}</label>
                                       </div>
                                       <div id="edit-leverage-container" class="flex items-center gap-4 ${currentLeverage > 1 ? '' : 'opacity-50'} transition-opacity">
                                            <input id="edit-leverage-slider" type="range" min="1" max="100" value="${currentLeverage}" class="custom-slider flex-grow" ${currentLeverage > 1 ? '' : 'disabled'}>
                                            <span id="edit-leverage-display" class="font-bold text-lg text-yellow-400 w-16 text-center">${currentLeverage}x</span>
                                       </div>
                                       <input type="hidden" id="edit-leverage" value="${currentLeverage}">
                                   ` : (trade.leverage > 1 ? `<div class="text-sm text-gray-400 mt-2">Leva Applicata: <span class="font-semibold text-white">${trade.leverage}x</span></div>` : '')}
                               </div>
                               <div class="flex justify-end items-center mt-4"><button type="submit" class="modal-btn bg-yellow-500 hover:bg-yellow-600 text-black">${t('saveChanges')}</button></div>`;
                }
                return `<div class="modal-overlay"><div class="modal-content max-w-md"><button class="absolute top-3 right-4 text-3xl font-light text-gray-400 hover:text-white" data-action="close-modal">&times;</button><form id="trade-form" class="modal-body">${content}</form></div></div>`;
            }

            function renderNoteModal() {
                const { date, text } = state.noteModal;
                const formattedDate = formatDate(date);
                return `<div class="modal-overlay">
                            <div class="modal-content max-w-md">
                                <button class="absolute top-3 right-4 text-3xl font-light text-gray-400 hover:text-white" data-action="close-note-modal">&times;</button>
                                <form id="note-form" class="modal-body">
                                    <h2 class="text-lg font-bold mb-3 text-white">${t('noteFor')} ${formattedDate}</h2>
                                    <textarea id="note-text" class="modal-input" rows="8" placeholder="Scrivi qui la tua nota...">${text}</textarea>
                                    <div class="flex justify-end mt-4">
                                        <button type="submit" class="modal-btn bg-yellow-500 hover:bg-yellow-600 text-black">${t('saveNote')}</button>
                                    </div>
                                </form>
                            </div>
                        </div>`;
            }

            function renderConfirmationModal() {
                return `<div class="modal-overlay"><div class="modal-content max-w-md"><h2 class="text-xl font-bold mb-4 text-white">${t('confirmRequest')}</h2><p class="text-gray-300 mb-6">${t('deleteConfirmMsg')}</p><div class="flex justify-end gap-4"><button class="modal-btn bg-gray-600 hover:bg-gray-500" data-action="cancel-delete">${t('cancel')}</button><button class="modal-btn bg-red-600 hover:bg-red-700" data-action="confirm-delete">${t('confirm')}</button></div></div></div>`;
            }

            function renderInfoModal() {
                const { title, content, isLoading } = state.infoModal;
                let modalBody;
                if (isLoading) {
                    modalBody = `<div class="flex justify-center items-center h-48"><div class="loader"></div></div>`;
                } else {
                    modalBody = `<div class="text-sm leading-relaxed">${content || ""}</div>`;
                }

                const isNewsOrReportModal = title.includes(t('latestFinancialNews')) || title.startsWith(t('monthlyReportFor')) || title.startsWith(t('yearlyReportFor')) || title.startsWith(t('aiAnalysis')) || title.startsWith(t("termsAndConditions")) || title.startsWith(t("economicCalendar")) || title.startsWith(t('highImpactEvents')) || title.startsWith(t('statisticalWarning')) || title.startsWith(t('todaysAlerts'));
                const modalWidthClass = isNewsOrReportModal ? 'max-w-2xl' : 'max-w-md';

                return `<div class="modal-overlay">
                            <div class="modal-content ${modalWidthClass}">
                                <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-700">
                                    <h2 class="text-xl font-bold text-white">${title}</h2>
                                    <button class="text-3xl font-light text-gray-400 hover:text-white" data-action="close-info-modal">&times;</button>
                                </div>
                                <div class="modal-body">${modalBody}</div>
                            </div>
                        </div>`;
            }

            function renderIframeModal() {
                const { url, title } = state.iframeModal;
                return `
                    <div class="modal-overlay">
                        <div class="modal-content max-w-full h-full md:h-5/6 md:max-w-3xl flex flex-col">
                            <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-700 flex-shrink-0">
                                <h2 class="text-md font-bold text-white truncate pr-4">${title}</h2>
                                <button class="modal-btn bg-red-600 hover:bg-red-700 text-sm !p-2" data-action="close-iframe-modal">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                    <span class="hidden sm:inline ml-1">${t('close')}</span>
                                </button>
                            </div>
                            <div class="flex-grow overflow-hidden bg-white">
                                <iframe src="${url}" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin"></iframe>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderConverterModal() {
                const fiatOptions = state.fiatForConverter.map(fiat => `<option value="${fiat.code}">${fiat.name} (${fiat.code})</option>`).join('');
                const cryptoOptions = state.tickerData.map(coin => `<option value="${coin.id}">${coin.name} (${coin.symbol.toUpperCase()})</option>`).join('');

                return `
                    <div class="modal-overlay">
                        <div class="modal-content max-w-2xl">
                            <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-700">
                                <h2 class="text-xl font-bold text-white">${t('currencyConverter')}</h2>
                                <button class="text-3xl font-light text-gray-400 hover:text-white" data-action="close-converter-modal">&times;</button>
                            </div>
                            <div id="converter-body" class="modal-body space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-4 items-end relative">
                                    <div class="converter-col">
                                        <label for="converter-from-amount" class="block mb-2 text-sm font-medium text-gray-400">${t('from')}</label>
                                        <div class="relative">
                                            <input id="converter-from-amount" type="number" value="1" class="converter-input">
                                            <select id="converter-from-currency" class="converter-select">
                                                <optgroup label="${t('fiatCurrencies')}">${fiatOptions}</optgroup>
                                                <optgroup label="${t('cryptoCurrencies')}">${cryptoOptions}</optgroup>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-center pt-6 md:pt-0">
                                       <button data-action="swap-currencies" class="swap-btn">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                             <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                           </svg>
                                       </button>
                                    </div>
                                    <div class="converter-col">
                                         <label for="converter-to-amount" class="block mb-2 text-sm font-medium text-gray-400">${t('to')}</label>
                                        <div class="relative">
                                            <input id="converter-to-amount" type="number" placeholder="0.0" class="converter-input">
                                            <select id="converter-to-currency" class="converter-select">
                                                <optgroup label="${t('fiatCurrencies')}">${fiatOptions}</optgroup>
                                                <optgroup label="${t('cryptoCurrencies')}">${cryptoOptions}</optgroup>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div id="rate-display" class="text-center text-gray-400 text-sm pt-4"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderSideMenu() {
                const menuContainer = document.getElementById('side-menu');
                if (!menuContainer) return;

                const currencyOptionsHTML = state.supportedCurrencies
                    .map(c => `<option value="${c.code}" ${c.code === state.currentCurrency ? 'selected' : ''}>${c.code.toUpperCase()}</option>`)
                    .join('');
                
                const languageOptionsHTML = state.supportedLanguages
                    .map(l => `<option value="${l.code}" ${l.code === state.currentLanguage ? 'selected' : ''}>${l.shortName}</option>`)
                    .join('');
                
                const currentSymbol = getCurrencySymbol();

                let userSection = '';
                if (state.user) {
                    userSection = `
                        <div class="mt-auto pt-4 border-t border-gray-700">
                            <button data-action="logout" class="w-full flex items-center justify-center gap-2 p-2 rounded-lg text-red-400 hover:bg-red-900/50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                                <span>${t('signOut')}</span>
                            </button>
                        </div>
                    `;
                }


                menuContainer.innerHTML = `
                    <div class="flex justify-between items-center pb-4 mb-4 border-b border-gray-700">
                        <h2 class="text-xl font-poppins"><span class="text-white font-bold">${t('other')}</span></h2>
                        <button data-action="toggle-menu" class="p-2 rounded-md text-gray-400 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <nav class="flex flex-col gap-2 flex-grow">
                        <div class="flex items-center gap-3 p-2 rounded-lg text-gray-200 w-1/2 text-left bg-gray-800/50">
                            <div class="h-6 w-6 flex-shrink-0 flex items-center justify-center bg-gray-600 rounded-full">
                                <span class="text-white font-bold text-sm">${currentSymbol}</span>
                            </div>
                            <select id="currency-select" data-action="change-currency" class="native-hidden-select w-full bg-gray-700 border-none text-white text-sm rounded-lg focus:ring-yellow-500 focus:border-yellow-500 block p-2 cursor-pointer">
                                ${currencyOptionsHTML}
                            </select>
                        </div>
                        <div class="flex items-center gap-3 p-2 rounded-lg text-gray-200 w-1/2 text-left bg-gray-800/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                <path d="M9.5 7L7.5 12l2 5"></path>
                                <path d="M14.5 7l2 5-2 5"></path>
                            </svg>
                            <select id="language-select" data-action="change-language" class="native-hidden-select w-full bg-gray-700 border-none text-white text-sm rounded-lg focus:ring-yellow-500 focus:border-yellow-500 block p-2 cursor-pointer">
                                ${languageOptionsHTML}
                            </select>
                        </div>
                        <button data-action="open-converter" class="flex items-center gap-3 p-2 rounded-lg text-gray-200 hover:bg-gray-700 transition-colors w-full text-left">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 256 256"><path d="M184,24H72A24,24,0,0,0,48,48V208a24,24,0,0,0,24,24H184a24,24,0,0,0,24-24V48A24,24,0,0,0,184,24Zm8,184a8,8,0,0,1-8,8H72a8,8,0,0,1-8-8V48a8,8,0,0,1,8-8H184a8,8,0,0,1,8,8ZM100,124a12,12,0,1,1,12,12A12,12,0,0,1,100,124Zm44-12a12,12,0,1,1-12-12A12,12,0,0,1,144,112Zm-44,44a12,12,0,1,1,12,12A12,12,0,0,1,100,168Zm44-12a12,12,0,1,1-12-12A12,12,0,0,1,144,156Zm-20-76H100a8,8,0,0,1,0-16h24a8,8,0,0,1,0,16Z"></path></svg>
                            <span class="font-medium">${t('converter')}</span>
                        </button>
                        <button data-action="download-csv" class="flex items-center gap-3 p-2 rounded-lg text-gray-200 hover:bg-gray-700 transition-colors w-full text-left">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 256 256"><path d="M208,88H152V32a8,8,0,0,0-16,0V88H80a8,8,0,0,0-5.66,13.66l64,64a8,8,0,0,0,11.32,0l64-64A8,8,0,0,0,208,88ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path></svg>
                            <span class="font-medium">${t('downloadCSV')}</span>
                        </button>
                        <button data-action="generate-yearly-report" class="flex items-center gap-3 p-2 rounded-lg text-gray-200 hover:bg-gray-700 transition-colors w-full text-left">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 256 256"><path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Zm0,176H48V48H72v8a8,8,0,0,0,16,0V48h80v8a8,8,0,0,0,16,0V48h24Z"></path></svg>
                            <span class="font-medium">${t('yearlyReport')}</span>
                        </button>
                        <button data-action="show-info" class="flex items-center gap-3 p-2 rounded-lg text-gray-200 hover:bg-gray-700 transition-colors w-full text-left">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm16-40a8,8,0,0,1-8,8,16,16,0,0,1-16-16V128a8,8,0,0,1,16,0v40A8,8,0,0,1,144,176ZM112,88a12,12,0,1,1,12,12A12,12,0,0,1,112,88Z"></path></svg>
                            <span class="font-medium">${t('infoAndTerms')}</span>
                        </button>
                    </nav>
                    ${userSection}
                `;
            }

            // --- EVENT HANDLERS ---
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) {
                    if (e.target.classList.contains('modal-overlay')) {
                        state.modal.isOpen = false;
                        state.noteModal.isOpen = false;
                        state.confirmationModal.isOpen = false;
                        state.converterModal.isOpen = false;
                        state.iframeModal.isOpen = false;
                        if (!state.infoModal.isLoading) state.infoModal.isOpen = false;
                        render();
                    }
                    if (e.target.id === 'menu-overlay') {
                        toggleMenu(false);
                    }
                    return;
                }
                
                const action = target.dataset.action;
                const { mode, tradeId, date } = target.dataset;

                switch(action) {
                    case 'prev-year':
                        state.currentYear--;
                        handleFetchEconomicCalendar(false);
                        break;
                    case 'next-year':
                        state.currentYear++;
                        handleFetchEconomicCalendar(false);
                        break;
                    case 'prev-month':
                        if (state.currentMonthIndex === 0) {
                            state.currentYear--;
                            state.currentMonthIndex = 11;
                        } else {
                            state.currentMonthIndex--;
                        }
                        handleFetchEconomicCalendar(false);
                        break;
                    case 'next-month':
                        if (state.currentMonthIndex === 11) {
                            state.currentYear++;
                            state.currentMonthIndex = 0;
                        } else {
                            state.currentMonthIndex++;
                        }
                        handleFetchEconomicCalendar(false);
                        break;
                    case 'toggle-menu':
                        toggleMenu();
                        break;
                    case 'open-modal':
                        state.modal = { isOpen: true, mode, data: { tradeId } };
                        render();
                        break;
                    case 'open-note-modal':
                        const existingNote = state.notes.find(n => n.id === date);
                        state.noteModal = { isOpen: true, date: date, text: existingNote ? existingNote.text : '' };
                        render();
                        break;
                    case 'delete-trade':
                        state.confirmationModal = { isOpen: true, message: t('deleteConfirmMsg'), onConfirm: () => deleteTrade(tradeId) };
                        render();
                        break;
                    case 'confirm-delete': 
                        if (state.confirmationModal.onConfirm) state.confirmationModal.onConfirm();
                        state.confirmationModal.isOpen = false;
                        render();
                        break;
                    case 'close-modal':
                    case 'cancel-delete':
                    case 'close-info-modal':
                    case 'close-converter-modal':
                    case 'close-note-modal':
                    case 'close-iframe-modal':
                        state.modal.isOpen = false;
                        state.noteModal.isOpen = false;
                        state.confirmationModal.isOpen = false;
                        state.converterModal.isOpen = false;
                        state.iframeModal.isOpen = false;
                        if (!state.infoModal.isLoading) state.infoModal.isOpen = false;
                        render();
                        break;
                    case 'open-news-iframe':
                        e.preventDefault();
                        const url = target.dataset.url;
                        const title = target.dataset.title;
                        state.iframeModal = { isOpen: true, url: url, title: title };
                        render();
                        break;
                    case 'open-converter':
                        state.converterModal.isOpen = true;
                        render();
                        if (state.tickerData.length > 1) {
                            document.getElementById('converter-from-currency').value = 'EUR';
                            document.getElementById('converter-to-currency').value = 'USD';
                            handleConversion();
                        }
                        toggleMenu(false);
                        break;
                    case 'swap-currencies':
                        handleSwapCurrencies();
                        break;
                    case 'generate-monthly-report': handleGenerateMonthlyReport(); break;
                    case 'generate-yearly-report': handleGenerateYearlyReport(state.currentYear); break;
                    case 'fetch-news': handleFetchNews(); break;
                    case 'download-csv': 
                        handleDownloadCsv(); 
                        toggleMenu(false);
                        break;
                    case 'fetch-economic-calendar': handleFetchEconomicCalendar(); break;
                    case 'fetch-ai-analysis': handleFetchAiAnalysis(); break;
                    case 'show-info': 
                        handleShowInfo();
                        toggleMenu(false);
                        break;
                    case 'toggle-auth-form':
                        state.auth.mode = state.auth.mode === 'login' ? 'register' : 'login';
                        state.auth.error = null;
                        render();
                        loadCredentials();
                        break;
                    case 'logout':
                        state.auth = { mode: 'login', error: null, isLoading: false };
                        signOut(auth);
                        break;
                    case 'show-alert-info':
                        const alertDate = target.dataset.date;
                        const alertData = state.alerts.find(a => a.date === alertDate);
                        if (alertData) {
                            const title = `${t('highImpactEvents')} - ${formatDate(alertDate)}`;
                            const content = alertData.events.map(event => `
                                <div class="p-3 mb-2 bg-gray-800 rounded-lg border border-gray-700">
                                    <p class="font-semibold text-white">${event.event} (${event.country})</p>
                                    <p class="text-sm text-gray-400">Ora: ${event.time || 'N/D'}</p>
                                </div>
                            `).join('');
                            state.infoModal = { isOpen: true, title, content, isLoading: false };
                            render();
                        }
                        break;
                    case 'show-statistical-alert':
                        const statDate = target.dataset.date;
                        const statAlert = getStatisticalAlertForDate(new Date(statDate + 'T00:00:00'));
                        if(statAlert) {
                            state.infoModal = { isOpen: true, title: statAlert.title, content: `<p>${statAlert.message}</p>`, isLoading: false };
                            render();
                        }
                        break;
                }
            });

            document.body.addEventListener('change', (e) => {
                const currencyTarget = e.target.closest('[data-action="change-currency"]');
                if (currencyTarget) {
                    const currency = currencyTarget.value;
                    if (currency && currency !== state.currentCurrency) {
                        state.currentCurrency = currency;
                        saveSettings();
                        render();
                        toggleMenu(false);
                    }
                }

                const langTarget = e.target.closest('[data-action="change-language"]');
                if (langTarget) {
                    const lang = langTarget.value;
                    if (lang && lang !== state.currentLanguage) {
                        state.currentLanguage = lang;
                        saveSettings();
                        render();
                        toggleMenu(false);
                    }
                }
                
                if (e.target.closest('#converter-body')) {
                    handleConversion(e);
                }

                const leverageToggle = e.target.closest('#open-leverage-toggle, #edit-leverage-toggle');
                if (leverageToggle) {
                    const isEdit = leverageToggle.id.startsWith('edit');
                    const prefix = isEdit ? 'edit' : 'open';
                    const container = document.getElementById(`${prefix}-leverage-container`);
                    const slider = document.getElementById(`${prefix}-leverage-slider`);
                    const display = document.getElementById(`${prefix}-leverage-display`);
                    const hiddenInput = document.getElementById(`${prefix}-leverage`);

                    if (leverageToggle.checked) {
                        container.classList.remove('opacity-50');
                        slider.disabled = false;
                        if (slider.value === '1') {
                            slider.value = 2;
                            display.textContent = '2x';
                            hiddenInput.value = 2;
                        }
                    } else {
                        container.classList.add('opacity-50');
                        slider.disabled = true;
                        slider.value = 1;
                        display.textContent = '1x';
                        hiddenInput.value = 1;
                    }
                }
            });

            document.body.addEventListener('input', (e) => {
                if (e.target.closest('#converter-body')) {
                    handleConversion(e);
                }
                
                if (e.target.id === 'open-leverage-slider' || e.target.id === 'edit-leverage-slider') {
                    const slider = e.target;
                    const displayId = slider.id.replace('-slider', '-display');
                    const hiddenInputId = slider.id.replace('-slider', '');
                    const display = document.getElementById(displayId);
                    const hiddenInput = document.getElementById(hiddenInputId);
                    if (display && hiddenInput) {
                        const value = slider.value;
                        display.textContent = `${value}x`;
                        hiddenInput.value = value;
                    }
                }
            });
            
            document.body.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (e.target.id === 'auth-form') {
                    const emailInput = document.getElementById('auth-email');
                    const passwordInput = document.getElementById('auth-password');
                    const stayLoggedInCheckbox = document.getElementById('stay-logged-in');
                    
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    const stayLoggedIn = stayLoggedInCheckbox?.checked;
                    const action = state.auth.mode;

                    state.auth.isLoading = true;
                    state.auth.error = null;
                    render(); 

                    document.getElementById('auth-email').value = email;
                    document.getElementById('auth-password').value = password;
                    if (stayLoggedInCheckbox) {
                        document.getElementById('stay-logged-in').checked = stayLoggedIn;
                    }

                    try {
                        if (action === 'register') {
                            await setPersistence(auth, browserLocalPersistence);
                            await createUserWithEmailAndPassword(auth, email, password);
                            localStorage.removeItem('tradefolioCredentials');
                        } else {
                            const persistenceType = stayLoggedIn ? browserLocalPersistence : browserSessionPersistence;
                            await setPersistence(auth, persistenceType);
                            await signInWithEmailAndPassword(auth, email, password);
                            
                            if (stayLoggedIn) {
                                const credentials = { email, password: btoa(password) };
                                localStorage.setItem('tradefolioCredentials', JSON.stringify(credentials));
                            } else {
                                localStorage.removeItem('tradefolioCredentials');
                            }
                        }
                    } catch (error) {
                        console.error("Authentication error:", error.code, error.message);
                        state.auth.error = error.message;
                        state.auth.isLoading = false;
                        render(); 

                        document.getElementById('auth-email').value = email;
                        document.getElementById('auth-password').value = password;
                        if (stayLoggedInCheckbox) {
                            document.getElementById('stay-logged-in').checked = stayLoggedIn;
                        }
                    }
                    return;
                }

                if (e.target.id === 'trade-form') {
                    const { mode, data } = state.modal;

                    if (mode === 'open') {
                        const priceInCurrentCurrency = parseFloat(document.getElementById('open-price').value);
                        const newTrade = { 
                            purchaseDate: document.getElementById('open-date').value, 
                            purchasePrice: convertFromCurrentCurrencyToUSD(priceInCurrentCurrency), 
                            quantity: parseFloat(document.getElementById('open-quantity').value), 
                            leverage: parseInt(document.getElementById('open-leverage').value, 10) || 1,
                            status: 'open', 
                            cryptoSymbol: document.getElementById('open-crypto-select').value 
                        };
                        if(newTrade.purchaseDate && !isNaN(newTrade.purchasePrice) && !isNaN(newTrade.quantity) && newTrade.cryptoSymbol) {
                            await addTrade(newTrade);
                        }
                    } else if (mode === 'close') {
                        const tradeId = document.getElementById('close-trade-select').value;
                        if (tradeId) {
                            const priceInCurrentCurrency = parseFloat(document.getElementById('close-price').value);
                            const updatedData = {
                                saleDate: document.getElementById('close-date').value,
                                salePrice: convertFromCurrentCurrencyToUSD(priceInCurrentCurrency),
                                status: 'closed'
                            };
                            await updateTrade(tradeId, updatedData);
                        }
                    } else if (mode === 'edit_open' || mode === 'edit_closed') {
                        const tradeId = data.tradeId;
                        const purchasePriceInCurrent = parseFloat(document.getElementById('edit-purchase-price').value);
                        const updatedData = {
                            purchaseDate: document.getElementById('edit-purchase-date').value,
                            purchasePrice: convertFromCurrentCurrencyToUSD(purchasePriceInCurrent),
                            quantity: parseFloat(document.getElementById('edit-quantity').value),
                            cryptoSymbol: document.getElementById('edit-crypto-symbol').value.trim().toUpperCase(),
                        };
                        if (mode === 'edit_open') {
                            updatedData.leverage = parseInt(document.getElementById('edit-leverage').value, 10) || 1;
                        }
                        if (mode === 'edit_closed') {
                            const salePriceInCurrent = parseFloat(document.getElementById('edit-sale-price').value);
                            updatedData.saleDate = document.getElementById('edit-sale-date').value;
                            updatedData.salePrice = convertFromCurrentCurrencyToUSD(salePriceInCurrent);
                        }
                        await updateTrade(tradeId, updatedData);
                    }
                    
                    state.modal.isOpen = false;
                    render();
                }

                if (e.target.id === 'note-form') {
                    const date = state.noteModal.date;
                    const text = document.getElementById('note-text').value;
                    await saveNote(date, text);
                    state.noteModal.isOpen = false;
                    render();
                }
            });

            function toggleMenu(forceState) {
                state.isMenuOpen = typeof forceState === 'boolean' ? forceState : !state.isMenuOpen;
                render();
            }

            // --- REPORT GENERATION ---
            function generateReportContent(trades, currencySymbol) {
                const totalProfitUSD = trades.reduce((acc, t) => acc + t.netProfit, 0);
                const totalProfit = convertToCurrentCurrency(totalProfitUSD);
                
                const winningTrades = trades.filter(t => t.netProfit > 0);
                const losingTrades = trades.filter(t => t.netProfit <= 0);
                
                const wins = winningTrades.length;
                const losses = losingTrades.length;
                const winRate = trades.length > 0 ? (wins / trades.length) * 100 : 0;
                
                const totalWinAmount = convertToCurrentCurrency(winningTrades.reduce((acc, t) => acc + t.netProfit, 0));
                const totalLossAmount = convertToCurrentCurrency(losingTrades.reduce((acc, t) => acc + t.netProfit, 0));
                
                const averageWin = wins > 0 ? totalWinAmount / wins : 0;
                const averageLoss = losses > 0 ? totalLossAmount / losses : 0;
                
                const profitFactor = (totalLossAmount !== 0) ? Math.abs(totalWinAmount / totalLossAmount) : Infinity;

                const bestTrade = trades.reduce((max, t) => t.netProfit > max.netProfit ? t : max, { netProfit: -Infinity });
                const worstTrade = trades.reduce((min, t) => t.netProfit < min.netProfit ? t : min, { netProfit: Infinity });

                const tradeCounts = trades.reduce((acc, t) => {
                    acc[t.cryptoSymbol] = (acc[t.cryptoSymbol] || 0) + 1;
                    return acc;
                }, {});
                const mostTraded = Object.keys(tradeCounts).reduce((a, b) => tradeCounts[a] > tradeCounts[b] ? a : b, '');

                return `
                    <div class="grid grid-cols-2 gap-3">
                        <div class="col-span-2 bg-gray-800 p-4 rounded-xl text-center">
                            <div class="text-4xl mb-2">ðŸ’°</div>
                            <p class="text-sm text-gray-400 uppercase tracking-wider">Profitto Netto Totale</p>
                            <p class="text-3xl font-bold ${totalProfit >= 0 ? 'profit' : 'loss'}">${totalProfit.toFixed(2)} ${currencySymbol}</p>
                        </div>
                        <div class="col-span-2 bg-gray-800 p-4 rounded-xl text-center">
                            <div class="text-4xl mb-2">ðŸ“Š</div>
                            <p class="text-sm text-gray-400 uppercase tracking-wider">Tasso di Vittoria</p>
                            <p class="text-3xl font-bold">${winRate.toFixed(1)}%</p>
                            <div class="w-full bg-gray-700 rounded-full h-4 mt-3 flex overflow-hidden border-2 border-gray-900/50">
                                <div class="bg-green-500 h-full" style="width: ${winRate}%" title="Vittorie: ${wins}"></div>
                            </div>
                            <div class="flex justify-between text-sm mt-2 px-1">
                                <span class="text-green-400">Vittorie: ${wins}</span>
                                <span class="text-red-400">Perdite: ${losses}</span>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-xl text-center">
                            <div class="text-3xl mb-1">ðŸ“ˆ</div>
                            <p class="text-xs text-gray-400">Profitto Medio</p>
                            <p class="text-lg font-bold profit">${averageWin.toFixed(2)} ${currencySymbol}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-xl text-center">
                            <div class="text-3xl mb-1">ðŸ“‰</div>
                            <p class="text-xs text-gray-400">Perdita Media</p>
                            <p class="text-lg font-bold loss">${averageLoss.toFixed(2)} ${currencySymbol}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-xl text-center">
                            <div class="text-3xl mb-1">âš–ï¸</div>
                            <p class="text-xs text-gray-400">Profit Factor</p>
                            <p class="text-xl font-bold">${isFinite(profitFactor) ? profitFactor.toFixed(2) : 'âˆž'}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-xl text-center">
                            <div class="text-3xl mb-1">ðŸ”„</div>
                            <p class="text-xs text-gray-400">Asset piÃ¹ Scambiato</p>
                            <p class="text-xl font-bold">${mostTraded}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-xl text-center">
                            <div class="text-3xl mb-1">ðŸ†</div>
                            <p class="text-xs text-gray-400">Miglior Trade</p>
                            <p class="text-lg font-bold profit">${convertToCurrentCurrency(bestTrade.netProfit).toFixed(2)} ${currencySymbol}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-xl text-center">
                            <div class="text-3xl mb-1">ðŸ‘Ž</div>
                            <p class="text-xs text-gray-400">Peggior Trade</p>
                            <p class="text-lg font-bold loss">${convertToCurrentCurrency(worstTrade.netProfit).toFixed(2)} ${currencySymbol}</p>
                        </div>
                    </div>
                `;
            }

            function handleGenerateMonthlyReport() {
                const { currentYear, currentMonthIndex, trades } = state;
                const currencySymbol = getCurrencySymbol();
                const monthName = translations[state.currentLanguage].monthNames[currentMonthIndex];
                const monthKey = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}`;
                const tradesInMonth = trades.filter(t => t.status === 'closed' && t.saleDate && t.saleDate.startsWith(monthKey)).map(calculateTradeProfits);

                if (tradesInMonth.length === 0) {
                    state.infoModal = { isOpen: true, title: t('monthlyReportFor') + ` ${monthName}`, content: `<p>${t('noTradesThisMonth')}</p>`, isLoading: false };
                } else {
                    const content = generateReportContent(tradesInMonth, currencySymbol);
                    state.infoModal = { isOpen: true, title: t('monthlyReportFor') + ` ${monthName}`, content, isLoading: false };
                }
                render();
            }

            function handleGenerateYearlyReport(year) {
                const { trades } = state;
                const currencySymbol = getCurrencySymbol();
                const tradesInYear = trades.filter(t => t.status === 'closed' && t.saleDate && t.saleDate.startsWith(year)).map(calculateTradeProfits);

                if (tradesInYear.length === 0) {
                    state.infoModal = { isOpen: true, title: t('yearlyReportFor') + ` ${year}`, content: `<p>${t('noTradesThisYear')}</p>`, isLoading: false };
                } else {
                    const content = generateReportContent(tradesInYear, currencySymbol);
                    state.infoModal = { isOpen: true, title: t('yearlyReportFor') + ` ${year}`, content, isLoading: false };
                }
                render();
            }
            
            // --- CSV DOWNLOAD FUNCTION ---
            function handleDownloadCsv() {
                const { trades } = state;
                if (trades.length === 0) return;
                
                const headers = "ID,Simbolo,Data Acquisto,Prezzo Acquisto (USD),QuantitÃ ,Leva,Data Vendita,Prezzo Vendita (USD),Stato,Profitto Netto (USD),Profitto (%)";
                const rows = trades.map(trade => {
                    const p = calculateTradeProfits(trade);
                    return [
                        trade.id,
                        trade.cryptoSymbol,
                        trade.purchaseDate,
                        trade.purchasePrice,
                        trade.quantity,
                        trade.leverage || 1,
                        trade.saleDate || '',
                        trade.salePrice || '',
                        trade.status,
                        p.netProfit.toFixed(4),
                        p.percentageProfit.toFixed(2)
                    ].join(',');
                }).join('\n');
                
                const csvContent = `data:text/csv;charset=utf-8,${headers}\n${rows}`;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `tradefolio_report_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- API FUNCTIONS WITH RETRY LOGIC ---
            async function fetchWithRetry(url, options, maxRetries = 3) {
                let attempt = 0;
                let delay = 1000; // start with 1 second

                while (attempt < maxRetries) {
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) {
                            return response; // Success
                        }
                        // Only retry on server errors (5xx)
                        if (response.status >= 500 && response.status <= 599) {
                             throw new Error(`API fallita con stato: ${response.status}`);
                        } else {
                            // Don't retry on client errors (4xx) or other issues, fail immediately
                            return response;
                        }
                    } catch (error) {
                        attempt++;
                        if (attempt >= maxRetries) {
                            console.error(`Tutti i tentativi di fetch sono falliti per ${url}`, error);
                            throw error; // Re-throw the last error after all retries
                        }
                        console.warn(`Tentativo ${attempt} fallito. Nuovo tentativo in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }

            // --- GNEWS FUNCTIONS ---
            function formatNews(newsItems, fromCache = false) {
                const cacheStatus = fromCache ? `<p class="text-xs text-gray-500 mb-2">${t('fromCache')}</p>` : '';
                return cacheStatus + newsItems.map(item => `
                    <div class="p-3 mb-2 bg-gray-800 rounded-lg border border-gray-700 hover:bg-gray-700 transition-colors">
                        <a href="${item.url}" target="_blank" data-action="open-news-iframe" data-url="${item.url}" data-title="${item.title}" class="block">
                            <h3 class="font-semibold text-white">${item.title}</h3>
                            <p class="text-xs text-gray-400 mt-1">${item.source.name} - ${new Date(item.publishedAt).toLocaleString()}</p>
                            <p class="text-sm text-gray-300 mt-2">${item.description}</p>
                        </a>
                    </div>
                `).join('');
            }
            
            async function handleFetchNews() {
                if (!state.user || !state.gnewsApiKey) return;
                state.infoModal = { isOpen: true, title: t('searchingRealTimeNews'), content: '', isLoading: true };
                render();

                const cacheKey = `newsCache`;
                const cacheRef = doc(db, "users", state.user.uid, "cache", cacheKey);

                try {
                    const docSnap = await getDoc(cacheRef);
                    const now = new Date();
                    const oneHour = 60 * 60 * 1000;
                    
                    if (docSnap.exists() && (now - docSnap.data().timestamp.toDate()) < oneHour) {
                        const news = JSON.parse(docSnap.data().articles);
                        state.infoModal = { isOpen: true, title: t('latestFinancialNews'), content: formatNews(news, true), isLoading: false };
                    } else {
                        const lang = state.currentLanguage === 'it' ? 'it' : 'en';
                        const url = `https://gnews.io/api/v4/top-headlines?category=business&lang=${lang}&country=it,us&max=10&apikey=${state.gnewsApiKey}`;
                        const response = await fetchWithRetry(url, {});
                        if (!response.ok) throw new Error(`GNews API fallita: ${response.status}`);
                        const data = await response.json();
                        await setDoc(cacheRef, { articles: JSON.stringify(data.articles), timestamp: new Date() });
                        state.infoModal = { isOpen: true, title: t('latestFinancialNews'), content: formatNews(data.articles), isLoading: false };
                    }
                } catch (error) {
                    console.error("Errore nel caricare le notizie:", error);
                    state.infoModal = { isOpen: true, title: t('error'), content: `<p>${t('errorLoadingNews')}</p>`, isLoading: false };
                } finally {
                    render();
                }
            }
            
            // --- ECONOMIC CALENDAR FUNCTIONS ---
            const getCountryFlagEmoji = (country) => {
                const lowerCountry = (country || '').toLowerCase();
                if (lowerCountry.includes('usa') || lowerCountry.includes('united states')) return 'ðŸ‡ºðŸ‡¸';
                if (lowerCountry.includes('euro') || lowerCountry.includes('ez')) return 'ðŸ‡ªðŸ‡º';
                if (lowerCountry.includes('cina') || lowerCountry.includes('china')) return 'ðŸ‡¨ðŸ‡³';
                if (lowerCountry.includes('giappone') || lowerCountry.includes('japan')) return 'ðŸ‡¯ðŸ‡µ';
                if (lowerCountry.includes('germania') || lowerCountry.includes('germany')) return 'ðŸ‡©ðŸ‡ª';
                if (lowerCountry.includes('regno unito') || lowerCountry.includes('uk')) return 'ðŸ‡¬ðŸ‡§';
                if (lowerCountry.includes('italia') || lowerCountry.includes('italy')) return 'ðŸ‡®ðŸ‡¹';
                return 'ðŸ³ï¸'; // Default flag
            };

            function formatEconomicCalendar(events, fromCache = false) {
                const cacheStatus = fromCache ? `<p class="text-xs text-gray-500 mb-2">${t('fromCache')}</p>` : '';
                return cacheStatus + events.map(event => `
                    <div class="p-3 mb-2 bg-gray-800 rounded-lg border border-gray-700 grid grid-cols-3 gap-2 items-center">
                        <div>
                            <p class="font-semibold text-white">${event.date}</p>
                            <p class="text-sm text-gray-400">${event.time || ''}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-white">${event.event}</p>
                            <p class="text-sm text-gray-400">${getCountryFlagEmoji(event.country)} ${event.country}</p>
                        </div>
                        <div class="text-right">
                            ${renderStars(event.impact)}
                        </div>
                    </div>
                `).join('');
            }

            function renderStars(impact) {
                const impactLower = (impact || '').toLowerCase();
                if (impactLower === 'alta') return '<span class="star-filled">â˜…â˜…â˜…</span>';
                if (impactLower === 'media') return '<span class="star-filled">â˜…â˜…</span><span class="star-empty">â˜†</span>';
                return '<span class="star-filled">â˜…</span><span class="star-empty">â˜†â˜†</span>';
            }

            async function handleFetchEconomicCalendar(showModal = true) {
                if (!state.user || !state.apiKey) return;
                if (showModal) {
                    state.infoModal = { isOpen: true, title: t('loadingCalendar'), content: '', isLoading: true };
                    render();
                }
                const { currentYear, currentMonthIndex } = state;
                const monthName = translations[state.currentLanguage].monthNames[currentMonthIndex];
                const cacheKey = `economicCalendar_${currentYear}_${currentMonthIndex}`;
                const cacheRef = doc(db, "users", state.user.uid, "cache", cacheKey);
                try {
                    const docSnap = await getDoc(cacheRef);
                    const now = new Date();
                    const oneDay = 24 * 60 * 60 * 1000;
                    let calendarEvents;
                    if (docSnap.exists() && (now - docSnap.data().timestamp.toDate()) < oneDay) {
                        calendarEvents = JSON.parse(docSnap.data().events);
                        if (showModal) {
                           state.infoModal = { isOpen: true, title: `${t('economicCalendar')} - ${monthName} ${currentYear}`, content: formatEconomicCalendar(calendarEvents, true), isLoading: false };
                        }
                    } else {
                        if (showModal) {
                            state.infoModal = { isOpen: true, title: t('searchingLive'), content: '', isLoading: true };
                            render();
                        }
                        const prompt = `Fornisci il calendario economico per ${monthName} ${currentYear} per USA, Eurozona, Cina, Giappone, Germania e Regno Unito. Includi data, ora (CET), paese, nome evento, impatto ('Bassa', 'Media', 'Alta'), valore precedente e previsto.`;
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${state.apiKey}`;
                        const payload = {
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { 
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "date": { "type": "STRING" },
                                            "time": { "type": "STRING" },
                                            "country": { "type": "STRING" },
                                            "event": { "type": "STRING" },
                                            "impact": { "type": "STRING" },
                                            "previous": { "type": "STRING" },
                                            "forecast": { "type": "STRING" }
                                        },
                                        required: ["date", "country", "event", "impact"]
                                    }
                                }
                            }
                        };
                        const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`API fallita: ${response.status}`);
                        const result = await response.json();
                        const calendarText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (calendarText) {
                            calendarEvents = JSON.parse(calendarText);
                            await setDoc(cacheRef, { events: JSON.stringify(calendarEvents), timestamp: new Date() });
                            if (showModal) {
                                state.infoModal = { isOpen: true, title: `${t('economicCalendar')} - ${monthName} ${currentYear}`, content: formatEconomicCalendar(calendarEvents), isLoading: false };
                            }
                        } else { throw new Error("Nessun contenuto ricevuto dall'API."); }
                    }
                    if (calendarEvents) {
                        const highImpactEvents = calendarEvents.filter(e => e.impact && e.impact.toLowerCase() === 'alta');
                        const groupedByDate = highImpactEvents.reduce((acc, event) => {
                            const date = event.date;
                            if (!acc[date]) acc[date] = [];
                            acc[date].push(event);
                            return acc;
                        }, {});
                        state.alerts = Object.entries(groupedByDate).map(([date, events]) => ({ date, events }));
                    }
                } catch (error) {
                    console.error("Errore nel caricare il calendario:", error);
                    if (showModal) {
                        state.infoModal = { isOpen: true, title: t('error'), content: `<p>${t('errorLoadingCalendar')}</p>`, isLoading: false };
                    }
                } finally {
                    render();
                }
            }

            // --- AI ANALYSIS FUNCTION ---
            function formatAiAnalysis(data) {
                const { overview, strengths, weaknesses, suggestions } = data;
                
                const renderList = (items) => items.map(item => `<li class="flex items-start gap-3"><span class="mt-1 text-yellow-400">â—†</span><span>${item}</span></li>`).join('');

                return `
                    <div class="space-y-4">
                        <div class="bg-gray-800 p-4 rounded-xl">
                            <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">ðŸ“Š Panoramica Generale</h3>
                            <p class="text-gray-300">${overview}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-xl">
                            <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">ðŸ’ª Punti di Forza</h3>
                            <ul class="space-y-2 text-gray-300">${renderList(strengths)}</ul>
                        </div>
                         <div class="bg-gray-800 p-4 rounded-xl">
                            <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">ðŸ“‰ Aree di Miglioramento</h3>
                            <ul class="space-y-2 text-gray-300">${renderList(weaknesses)}</ul>
                        </div>
                         <div class="bg-gray-800 p-4 rounded-xl">
                            <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">ðŸ’¡ Suggerimenti Pratici</h3>
                            <ul class="space-y-2 text-gray-300">${renderList(suggestions)}</ul>
                        </div>
                    </div>
                `;
            }

            async function handleFetchAiAnalysis() {
                if (!state.user || !state.apiKey) return;
                const { currentYear, currentMonthIndex, trades } = state;
                const monthName = translations[state.currentLanguage].monthNames[currentMonthIndex];
                const monthKey = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}`;
                const tradesInMonth = trades.filter(t => t.status === 'closed' && t.saleDate && t.saleDate.startsWith(monthKey)).map(calculateTradeProfits);

                if (tradesInMonth.length === 0) {
                    state.infoModal = { isOpen: true, title: t('aiAnalysis'), content: `<p>${t('noTradesToAnalyze')}</p>`, isLoading: false };
                    render();
                    return;
                }

                state.infoModal = { isOpen: true, title: t('aiAnalysis'), content: '', isLoading: true };
                render();

                const tradesSummary = tradesInMonth.map(t => `Trade in ${t.cryptoSymbol}: Profitto ${t.netProfit.toFixed(2)} USD, Profitto % ${t.percentageProfit.toFixed(2)}%`).join('\n');
                const prompt = `Agisci come un coach di trading esperto. Analizza la seguente performance di trading per ${monthName} ${currentYear}:\n${tradesSummary}\n\nFornisci un'analisi sintetica e costruttiva. Rispondi in formato JSON con questa struttura: { "overview": "stringa", "strengths": ["stringa", "stringa"], "weaknesses": ["stringa", "stringa"], "suggestions": ["stringa", "stringa"] }. Sii incoraggiante, usa un linguaggio chiaro e fornisci consigli pratici e attuabili.`;

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${state.apiKey}`;
                    const payload = { 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };
                    const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API fallita: ${response.status}`);
                    const result = await response.json();
                    const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const analysisData = JSON.parse(analysisText);
                    state.infoModal = { isOpen: true, title: t('aiAnalysis'), content: formatAiAnalysis(analysisData), isLoading: false };
                } catch (error) {
                    console.error("Errore analisi AI:", error);
                    state.infoModal = { isOpen: true, title: t('error'), content: `<p>Impossibile ottenere l'analisi AI in questo momento.</p>`, isLoading: false };
                } finally {
                    render();
                }
            }
            
            // --- INFO FUNCTION ---
            function handleShowInfo() {
                const content = `
                    <div class="space-y-4">
                        <p><strong>Tradefolio</strong> Ã¨ un'applicazione per il tracciamento delle operazioni di trading, progettata per aiutare gli utenti a monitorare le proprie performance e a prendere decisioni piÃ¹ informate.</p>
                        <p><strong>Versione:</strong> 6.10</p>
                        <p><strong>Sviluppatore:</strong> Fabio Amendola</p>
                        <p><strong>Disclaimer:</strong> Questa applicazione Ã¨ fornita "cosÃ¬ com'Ã¨", senza alcuna garanzia. L'utente si assume la piena responsabilitÃ  per l'uso dell'applicazione e per qualsiasi decisione finanziaria presa sulla base delle informazioni in essa contenute. Lo sviluppatore non Ã¨ responsabile per eventuali perdite finanziarie.</p>
                    </div>`;
                state.infoModal = { isOpen: true, title: t("termsAndConditions"), content, isLoading: false };
                render();
            }

            // --- CONVERTER FUNCTION ---
            function handleSwapCurrencies() {
                const fromAmountInput = document.getElementById('converter-from-amount');
                const fromCurrencySelect = document.getElementById('converter-from-currency');
                const toAmountInput = document.getElementById('converter-to-amount');
                const toCurrencySelect = document.getElementById('converter-to-currency');
                
                const fromCurrency = fromCurrencySelect.value;
                const toCurrency = toCurrencySelect.value;
                
                fromCurrencySelect.value = toCurrency;
                toCurrencySelect.value = fromCurrency;
                
                handleConversion();
            }

            async function handleConversion(event) {
                const fromAmountInput = document.getElementById('converter-from-amount');
                const fromCurrencySelect = document.getElementById('converter-from-currency');
                const toAmountInput = document.getElementById('converter-to-amount');
                const toCurrencySelect = document.getElementById('converter-to-currency');
                const rateDisplay = document.getElementById('rate-display');

                const fromAmount = parseFloat(fromAmountInput.value) || 0;
                const fromCurrency = fromCurrencySelect.value;
                const toCurrency = toCurrencySelect.value;
                
                rateDisplay.innerHTML = `<div class="loader !w-5 !h-5 !border-2 mx-auto"></div>`;

                const getPriceInUSD = (currency) => {
                    if (state.fiatForConverter.some(f => f.code === currency)) {
                        return 1 / (state.fiatRates[currency] || 1);
                    }
                    const crypto = state.tickerData.find(c => c.id === currency || c.symbol.toUpperCase() === currency);
                    return crypto ? crypto.current_price : null;
                };

                const fromPriceUSD = getPriceInUSD(fromCurrency);
                const toPriceUSD = getPriceInUSD(toCurrency);
                
                if (fromPriceUSD !== null && toPriceUSD !== null) {
                    const rate = fromPriceUSD / toPriceUSD;
                    const toAmount = fromAmount * rate;
                    toAmountInput.value = toAmount.toFixed(fromPriceUSD > toPriceUSD ? 8 : 2);
                    rateDisplay.textContent = `1 ${fromCurrency} = ${rate.toFixed(6)} ${toCurrency}`;
                } else {
                    toAmountInput.value = '';
                    rateDisplay.textContent = 'Conversione non disponibile';
                }
            }

            // --- API & INITIALIZATION ---
            async function fetchFiatRates() {
                if (!state.user) return;
                const cacheKey = `fiatRatesCache`;
                const cacheRef = doc(db, "users", state.user.uid, "cache", cacheKey);
                try {
                    const docSnap = await getDoc(cacheRef);
                    const now = new Date();
                    const sixHours = 6 * 60 * 60 * 1000;
                    if (docSnap.exists() && (now - docSnap.data().timestamp.toDate()) < sixHours) {
                        state.fiatRates = docSnap.data().rates;
                    } else {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        state.fiatRates = data.rates;
                        await setDoc(cacheRef, { rates: data.rates, timestamp: new Date() });
                    }
                } catch (error) {
                    console.error("Could not fetch fiat rates:", error);
                }
            }

            async function fetchTickerData() {
                if (!navigator.onLine) return;
                try {
                    const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    state.tickerData = await response.json();
                    render();
                } catch (error) {
                    console.error("Could not fetch ticker data:", error);
                }
            }
            
            // --- UI/AUTH FLOW MANAGEMENT ---
            function showApp() {
                const splashScreen = document.getElementById('splash-screen');
                const appContainer = document.getElementById('app-container');
                splashScreen.style.opacity = '0';
                splashScreen.style.pointerEvents = 'none';
                appContainer.classList.add('visible');
            }
            
            function showLoginScreen() {
                const splashScreen = document.getElementById('splash-screen');
                const appContainer = document.getElementById('app-container');
                splashScreen.style.opacity = '1';
                splashScreen.style.pointerEvents = 'auto';
                appContainer.classList.remove('visible');
                render();
                loadCredentials();
            }

            function loadCredentials() {
                const credentials = localStorage.getItem('tradefolioCredentials');
                if (credentials) {
                    try {
                        const { email, password } = JSON.parse(credentials);
                        document.getElementById('auth-email').value = email;
                        document.getElementById('auth-password').value = atob(password);
                        document.getElementById('stay-logged-in').checked = true;
                    } catch (e) { localStorage.removeItem('tradefolioCredentials'); }
                }
            }

            // --- AUTHENTICATION & APP START ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    state.user = user;
                    state.isMenuOpen = false; 
                    setupTradesListener(user.uid);
                    setupNotesListener(user.uid);
                    loadSettings();
                    
                    Promise.all([fetchTickerData(), fetchFiatRates()]).then(() => {
                        handleFetchEconomicCalendar(false).then(() => {
                            // NUOVO: Logica per il popup di avviso al login
                            setTimeout(() => {
                                const today = new Date();
                                const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                                
                                const economicAlert = state.alerts.find(a => a.date === todayString);
                                const statisticalAlert = getStatisticalAlertForDate(today);

                                if (economicAlert || statisticalAlert) {
                                    let alertContent = '';
                                    if (statisticalAlert) {
                                        alertContent += `<div class="p-3 mb-2 bg-red-900/30 rounded-lg border border-red-500/50">
                                            <p class="font-semibold text-white">${statisticalAlert.title}</p>
                                            <p class="text-sm text-gray-300">${statisticalAlert.message}</p>
                                        </div>`;
                                    }
                                    if (economicAlert) {
                                        alertContent += economicAlert.events.map(event => `
                                            <div class="p-3 mb-2 bg-gray-800 rounded-lg border border-gray-700">
                                                <p class="font-semibold text-white">${event.event} (${event.country})</p>
                                                <p class="text-sm text-gray-400">Ora: ${event.time || 'N/D'}</p>
                                            </div>
                                        `).join('');
                                    }
                                    state.infoModal = { isOpen: true, title: t('todaysAlerts'), content: alertContent, isLoading: false };
                                    render();
                                }
                            }, 1500); // Ritardo di 1.5s per mostrare il popup
                        }); 
                        
                        render(); 
                        showApp();
                    });
                    
                    setInterval(fetchTickerData, 90000);
                } else {
                    state.user = null;
                    state.isMenuOpen = false;
                    state.trades = [];
                    state.notes = [];
                    state.alerts = [];
                    if (state.tradesListener) state.tradesListener();
                    if (state.notesListener) state.notesListener();
                    showLoginScreen();
                }
            });
        });
    </script>
</body>
</html>

